<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Inventario QR – Mobile</title>
  <style>
    :root{
      --gap:14px;
      --muted:#6b7280;
      --b:#e5e7eb;
      --ok:#10b981;
      --warn:#f59e0b;
      --err:#ef4444;
      --bg:#0b0f14;
      --card:#0f141b;
      --text:#e5e7eb;
      --accent:#4f46e5;
    }

    *{box-sizing:border-box}

    html,body{height:100%}

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    header{
      position:sticky;
      top:0;
      background:linear-gradient(180deg,#0b0f14 0%, #0b0f14cc 100%);
      backdrop-filter:blur(8px);
      border-bottom:1px solid #1114;
      z-index:20;
    }

    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:16px;
    }

    h1{
      margin:0 0 4px;
      font-size:20px;
      letter-spacing:.2px;
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }

    .brand{
      font-size:12px;
      font-weight:500;
      color:#9aa6b2;
      line-height:1.2;
    }

    .op-label{
      font-size:12px;
      font-weight:500;
      color:#9aa6b2;
      line-height:1.2;
    }

    nav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    nav button{
      flex:1 1 auto;
      min-width:0;
      border:1px solid #202635;
      background:#121824;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      color:var(--text);
      font-size:14px;
      line-height:1.2;
      text-align:center;
    }

    nav button.active{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
      font-weight:600;
    }

    /* Home tab prende tutta la linea su schermi stretti */
    nav button[data-tab="tab-home"]{
      flex-basis:100%;
    }

    @media(min-width:768px){
      nav button{
        flex-grow:0;
        flex-basis:auto;
        font-size:13px;
        padding:8px 10px;
        border-radius:10px;
      }
      nav button[data-tab="tab-home"]{
        flex-basis:auto;
      }
    }

    h2{
      margin:14px 0 8px;
      font-size:18px;
    }

    .grid{
      display:grid;
      gap:var(--gap);
    }

    .cols-2{
      grid-template-columns:1fr;
    }

    @media(min-width:900px){
      .cols-2{
        grid-template-columns:1fr 1fr;
      }
    }

    .card{
      background:var(--card);
      border:1px solid #1b2230;
      border-radius:16px;
      padding:14px;
      position:relative;
      z-index:1;
    }

    label{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }

    input,
    textarea{
      width:100%;
      border:1px solid #253043;
      background:#0f141b;
      border-radius:12px;
      padding:12px 14px;
      color:var(--text);
      font-family:inherit;
      font-size:16px;
      line-height:1.3;
    }

    input::placeholder,
    textarea::placeholder{
      color:#94a3b8;
    }

    table{
      width:100%;
      border-collapse:collapse;
    }

    th,
    td{
      padding:10px;
      border-bottom:1px solid #1b2230;
      text-align:left;
      font-size:14px;
      vertical-align:top;
    }

    .table-scroll{
      width:100%;
      overflow-x:auto;
    }

    /* righe di controlli con wrap ordinato */
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
    }

    .row .btn{
      flex-shrink:0;
    }

    /* Barra comandi multiple con wrap a 2 colonne su mobile */
    .row.actions-wrap{
      justify-content:flex-start;
    }

    .row.actions-wrap .btn{
      flex:1 1 calc(50% - 10px);
      text-align:center;
    }

    @media(min-width:480px){
      .row.actions-wrap .btn{
        flex:0 0 auto;
      }
    }

    .btn{
      border:1px solid #253043;
      border-radius:12px;
      padding:12px 14px;
      background:var(--accent);
      color:#fff;
      cursor:pointer;
      font-size:15px;
      line-height:1.2;
    }

    .btn.ghost{
      background:#121824;
      color:var(--text);
    }

    .btn.danger{
      background:#7f1d1d;
      border-color:#7f1d1d;
    }

    .btn.sm{
      padding:8px 10px;
      font-size:13px;
      line-height:1.2;
      border-radius:10px;
    }

    @media(min-width:1024px){
      .btn{
        padding:10px 12px;
        font-size:14px;
      }
      .btn.sm{
        padding:6px 8px;
        font-size:12px;
      }
    }

    .muted{color:#9aa6b2}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .err{color:var(--err)}

    .qrbox{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:220px;
      background:#0b0f14;
      border:1px dashed #22304a;
      border-radius:16px;
    }

    .mono{
      font-family:ui-monospace,Menlo,Consolas,monospace;
      white-space:pre-wrap;
      font-size:13px;
      line-height:1.4;
    }

    video,
    canvas{
      max-width:100%;
    }

    .hidden{display:none}

    /* HOME CTA cards */
    .home-cta{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-top:16px;
    }

    .cta-main{
      display:flex;
      align-items:center;
      gap:12px;
      border:1px solid #22304a;
      background:#0f141b;
      border-radius:16px;
      padding:20px;
      cursor:pointer;
    }

    .cta-main .icon{
      width:44px;
      height:44px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#182034;
      font-size:20px;
      flex-shrink:0;
    }

    .cta-main .title{
      font-weight:600;
      font-size:16px;
      line-height:1.3;
      color:var(--text);
    }

    .cta-main .desc{
      font-size:13px;
      color:#9aa6b2;
      line-height:1.4;
    }

    @media(min-width:500px){
      .home-cta{
        grid-template-columns:1fr 1fr;
      }
    }

    /* PROGRESS BAR */
    .progress{
      height:12px;
      background:#1b2230;
      border-radius:999px;
      overflow:hidden;
      border:1px solid #253043;
    }

    .progress>span{
      display:block;
      height:100%;
      background:linear-gradient(90deg,#22c55e,#16a34a);
      width:0%;
    }

    /* PRINT MODE */
    @media print{
      header,
      .noprint,
      #camOverlay{
        display:none!important;
      }
      body{
        background:#fff;
        color:#000;
      }
      .print-sheet{
        display:block!important;
      }
    }

    .print-sheet{
      display:none;
      color:#000;
    }

    .print-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:18px;
      align-items:center;
    }

    .print-qr{
      border:1px solid #999;
      padding:12px;
      border-radius:12px;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    .print-qr canvas{
      width:100%;
      height:auto;
    }

    .print-list{
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:12px;
      line-height:1.4;
      white-space:pre-wrap;
    }

    /* FAB off */
    .fabbar{
      display:none !important;
    }

    /* Barra rientro sticky dentro la card */
    .r-toolbar{
      position:sticky;
      top:0;
      background:var(--card);
      border-bottom:1px solid #1b2230;
      border-radius:16px 16px 0 0;
      padding-bottom:12px;
      z-index:5;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* Pulsanti grossi (+/-/tutti/nessuno) */
    .r-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-start;
    }

    .btn.big{
      font-size:16px;
      padding:14px 16px;
      border-radius:14px;
      min-width:64px;
      text-align:center;
    }

    @media(min-width:768px){
      .btn.big{
        font-size:15px;
        padding:12px 14px;
        min-width:56px;
      }
    }

    /* Info articolo selezionato */
    .r-selected-box{
      background:#182034;
      border:1px solid #253043;
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      line-height:1.4;
      color:var(--text);
    }

    .r-selected-title{
      font-weight:600;
      font-size:14px;
      margin-bottom:4px;
      color:var(--text);
      word-break:break-word;
    }

    .r-selected-meta{
      font-size:12px;
      color:var(--muted);
    }

    /* Azioni globali rientro */
    .r-toolbar-sec{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }

    .r-toolbar-sec .btn{
      flex:1 1 calc(50% - 10px);
      text-align:center;
    }

    @media(min-width:600px){
      .r-toolbar-sec .btn{
        flex:0 0 auto;
      }
    }

    /* Avanzamento globale */
    .r-progress-block{
      border-top:1px solid #1b2230;
      padding-top:8px;
    }

    /* Wrapper scrollabile tabella rientro */
    .r-table-wrap{
      max-height:60vh;
      overflow-y:auto;
      margin-top:12px;
      border-top:1px solid #1b2230;
      padding-top:12px;
    }

    /* Riga selezionata tabella */
    tr.selected{
      background:#1a2538;
    }

    /* Input quantità rientrati */
    .rQtyInput{
      width:80px;
      max-width:100px;
      border-radius:8px;
      border:1px solid #253043;
      background:#0f141b;
      color:var(--text);
      padding:8px 10px;
      font-size:14px;
      line-height:1.2;
    }

    /* LOGIN overlay */
    #loginOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.75);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      z-index:9999;
    }

    #loginBox{
      background:#0f141b;
      border:1px solid #1b2230;
      border-radius:16px;
      padding:20px;
      width:100%;
      max-width:320px;
      box-shadow:0 30px 80px rgba(0,0,0,.8);
    }

    #loginBox h2{
      margin-top:0;
      font-size:18px;
      color:var(--text);
    }

    /* CAMERA overlay fullscreen */
    #camOverlay{
      position:fixed;
      inset:0;
      background:#000;
      color:#fff;
      display:none;
      flex-direction:column;
      z-index:9998;
    }

    #camHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 16px;
      background:rgba(0,0,0,.6);
      color:#fff;
      font-size:14px;
      z-index:2;
    }

    #camHeader .left,
    #camHeader .right{
      display:flex;
      gap:8px;
      align-items:center;
    }

    #camVideoWrap{
      position:relative;
      flex:1 1 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#000;
      overflow:hidden;
    }

    #camVideo{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
      background:#000;
    }

    #camFooter{
      padding:12px 16px;
      background:rgba(0,0,0,.6);
      font-size:13px;
      color:#ccc;
      text-align:center;
      min-height:44px;
    }

    .camBtn{
      background:#1f2937;
      border:1px solid #4b5563;
      color:#fff;
      border-radius:10px;
      padding:8px 10px;
      font-size:14px;
      line-height:1.2;
      min-width:60px;
      cursor:pointer;
    }

    .camBtn.danger{
      background:#7f1d1d;
      border-color:#7f1d1d;
    }

    .camBtn.active{
      background:#facc15;
      color:#000;
      border-color:#facc15;
    }

    /* Sezione etichetta nel printSheet */
    #printMeta{
      font-size:11px;
      line-height:1.4;
      color:#000;
      margin-top:8px;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>
        <span>Inventario QR</span>
        <span class="brand">Show Technologies TM</span>
      </h1>
      <div class="op-label" id="opInfo">Operatore: –</div>

      <nav class="noprint">
        <button data-tab="tab-home" class="active">Home</button>
        <button data-tab="tab-lista">Crea lista</button>
        <button data-tab="tab-qr">QR &amp; Stampa</button>
        <button data-tab="tab-decode">Leggi lista</button>
        <button data-tab="tab-rientro">Spunta</button>
        <span id="status" class="muted" style="margin-left:auto;flex-grow:0;flex-basis:auto"></span>
      </nav>
    </div>
  </header>

  <div class="wrap">
    <!-- TAB: HOME -->
    <section id="tab-home" class="tab">
      <h2>Benvenuto</h2>
      <div class="muted" style="font-size:14px;line-height:1.4;margin-bottom:12px">
        Scegli cosa vuoi fare.
      </div>

      <div class="home-cta">
        <div class="cta-main" data-go="tab-lista">
          <div class="icon">📝</div>
          <div>
            <div class="title">Crea lista</div>
            <div class="desc">Imposta baule, evento e aggiungi i pezzi.</div>
          </div>
        </div>

        <div class="cta-main" data-go="tab-decode">
          <div class="icon">📷</div>
          <div>
            <div class="title">Leggi lista</div>
            <div class="desc">Scannerizza un QR o PDF per caricare la lista.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: LISTA -->
    <section id="tab-lista" class="tab hidden">
      <h2>Lista articoli</h2>
      <div class="grid cols-2">
        <div class="card">
          <div class="row">
            <div style="flex:1">
              <label>ID baule</label>
              <input id="boxId" placeholder="Es. B-07">
            </div>
            <div style="flex:2">
              <label>Evento</label>
              <input id="eventName" placeholder="Es. Concerto Piazza">
            </div>
          </div>

          <div class="row">
            <div style="flex:3">
              <label>Descrizione</label>
              <input id="desc" placeholder="Es. Faro LED PAR 64">
            </div>
            <div style="flex:1">
              <label>Quantità</label>
              <input id="qty" type="number" min="1" value="1">
            </div>
            <button id="addItem" class="btn">Aggiungi</button>
          </div>
        </div>

        <div class="card">
          <div class="row actions-wrap">
            <button id="saveLocal" class="btn ghost">Salva in locale</button>
            <button id="loadLocal" class="btn ghost">Carica da locale</button>
            <button id="clearList" class="btn danger">Svuota lista</button>
            <button id="exportJson" class="btn ghost">Esporta JSON</button>
          </div>
          <div class="muted" style="margin-top:6px">
            Il salvataggio locale usa <code>localStorage</code>.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="table-scroll">
          <table id="itemsTbl">
            <thead>
              <tr>
                <th>#</th>
                <th>Descrizione</th>
                <th>Q.tà</th>
                <th class="noprint">Azioni</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- TAB: QR & STAMPA -->
    <section id="tab-qr" class="tab hidden">
      <h2>QR &amp; Stampa</h2>
      <div class="grid cols-2">
        <div class="card">
          <div class="row">
            <div style="flex:1">
              <label>Dimensione QR (mm lato)</label>
              <input id="sizeMm" type="number" value="40" min="25" max="120">
            </div>
            <div style="flex:1">
              <label>Quiet zone (moduli)</label>
              <input id="borderMods" type="number" value="4" min="1" max="16">
            </div>
          </div>

          <div class="row">
            <button id="btnGenQR" class="btn">Genera QR</button>
            <button id="btnDownloadPNG" class="btn ghost" disabled>Scarica PNG</button>
            <button id="btnPrint" class="btn ghost" disabled>Stampa scheda</button>
            <button id="btnPDFMain" class="btn ghost" disabled>PDF scheda</button>
          </div>

          <div class="muted" style="font-size:12px">
            ECC=H, schema <code>QRJ1:</code> (zlib + Base45).
          </div>

          <div id="qrBox" class="qrbox" aria-live="polite"></div>
          <div id="encInfo" class="muted" style="font-size:12px"></div>
        </div>

        <div class="card">
          <label>JSON canonico utilizzato</label>
          <textarea id="jsonCanon" rows="16" class="mono" readonly></textarea>
          <div class="muted" style="margin-top:6px">
            SHA-256: <span id="sha256" class="mono"></span>
          </div>
        </div>
      </div>

      <!-- foglio di stampa A4 landscape (usato da print e PDF) -->
      <div id="printSheet" class="print-sheet">
        <h2>Scheda baule</h2>
        <div class="print-grid">
          <div class="print-qr"><canvas id="printQR"></canvas></div>
          <div class="print-list">
            <div><strong>ID baule:</strong> <span id="pBox"></span></div>
            <div><strong>Evento:</strong> <span id="pEvent"></span></div>
            <div><strong>Operatore:</strong> <span id="pOperatore"></span></div>
            <div id="printMeta">
              <div><strong>Data/ora stampa:</strong> <span id="pWhen"></span></div>
            </div>
            <hr>
            <div id="pList"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: CARICA/VERIFICA -->
    <section id="tab-decode" class="tab hidden">
      <h2>Leggi/Verifica QR o PDF</h2>
      <div class="grid cols-2">
        <div class="card">
          <div class="row">
            <div style="flex:1;min-width:180px">
              <label>Carica immagine o PDF</label>
              <input id="fileInput" type="file" accept="image/*,application/pdf">
            </div>

            <div style="flex:1;min-width:180px">
              <label>Scatta foto QR</label>
              <input id="cameraShot" type="file" accept="image/*" capture="environment">
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="btnCamFull" class="btn ghost">Apri webcam live</button>
          </div>

          <div id="decStatus" class="muted" style="margin:8px 0"></div>

          <label style="margin-top:12px;display:block;">Testo letto</label>
          <div id="rawOut" class="mono muted"></div>

          <div class="row" style="margin-top:12px">
            <button id="btnSetCurrent" class="btn" disabled>Usa come lista corrente</button>
            <button id="btnCompare" class="btn ghost" disabled>Confronta con lista corrente</button>
          </div>
        </div>

        <div class="card">
          <label>JSON ricostruito</label>
          <textarea id="jsonDecoded" rows="16" class="mono"></textarea>
          <div id="cmpResult" class="muted" style="margin-top:6px"></div>
        </div>
      </div>
    </section>

    <!-- TAB: RIENTRO -->
    <section id="tab-rientro" class="tab hidden">
      <h2>Spunta articoli</h2>
      <div class="card">
        <!-- TOOLBAR RIENTRO -->
        <div class="r-toolbar">
          <!-- Pulsanti grandi -->
          <div class="r-buttons">
            <button class="btn big ghost" id="btnDecOne">-</button>
            <button class="btn big ghost" id="btnIncOne">+</button>
            <button class="btn big ghost" id="btnAllOne">Tutti</button>
            <button class="btn big ghost" id="btnZeroOne">Nessuno</button>
          </div>

          <!-- Recap articolo selezionato -->
          <div class="r-selected-box">
            <div class="r-selected-title" id="rSelName">Nessun articolo selezionato</div>
            <div class="r-selected-meta" id="rSelMeta">Previsti: — • Rientrati: — • Mancano: —</div>
          </div>

          <!-- Azioni globali -->
          <div class="r-toolbar-sec">
            <button id="rReset" class="btn ghost">Azzera tutto</button>
            <button id="rAll" class="btn ghost">Tutti rientrati</button>
            <button id="rExport" class="btn ghost">Esporta CSV</button>
            <button id="rPDF" class="btn">PDF rientro</button>
          </div>

          <!-- Avanzamento globale -->
          <div class="r-progress-block">
            <div class="muted" style="margin:8px 0 6px">Avanzamento rientro</div>
            <div class="progress" aria-label="Progresso rientro">
              <span id="rBar" style="width:0%"></span>
            </div>
            <div id="rPct" class="muted" style="margin-top:6px">0% • 0/0</div>
            <div id="rInfo" class="muted"></div>
          </div>
        </div>

        <!-- Tabella rientro scrollabile -->
        <div class="r-table-wrap">
          <div class="table-scroll">
            <table id="rTbl">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Descrizione</th>
                  <th>Prev.</th>
                  <th>Rientrati</th>
                  <th>Manca</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" class="hidden">
    <div id="loginBox">
      <h2>Inserisci il tuo nome</h2>
      <div style="font-size:13px;line-height:1.4;color:#9aa6b2;margin-bottom:12px">
        Lo useremo nei PDF e sulle etichette.
      </div>
      <label for="opNameInput" style="margin-bottom:4px">Operatore</label>
      <input id="opNameInput" placeholder="Es. Marco R.">
      <button id="opNameConfirm" class="btn" style="width:100%;margin-top:14px">Entra</button>
    </div>
  </div>

  <!-- CAMERA OVERLAY FULLSCREEN -->
  <div id="camOverlay">
    <div id="camHeader">
      <div class="left">
        <button id="camCloseBtn" class="camBtn danger">Chiudi</button>
      </div>
      <div class="right">
        <button id="camFlashBtn" class="camBtn" disabled>Flash</button>
      </div>
    </div>

    <div id="camVideoWrap">
      <video id="camVideo" autoplay playsinline></video>
      <canvas id="camSnap" class="hidden"></canvas>
    </div>

    <div id="camFooter">
      <span id="camStatus">Inizializzazione camera…</span>
    </div>
  </div>

  <!-- Service worker per offline -->
  <script>
    const CACHE_VERSION='qrj1-mobile-v3';
    const PRECACHE=[
      'https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js',
      'https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.asm.wasm',
      'https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.asm.data',
      'https://cdn.jsdelivr.net/pyodide/v0.25.1/full/packages.json',

      'https://cdn.jsdelivr.net/npm/@zxing/library@0.21.2/umd/index.min.js',
      'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js',
      'https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.js',

      'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js',
      'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js',
      'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js'
    ];
    if('serviceWorker' in navigator){
      const sw=`
        const C='${CACHE_VERSION}', PREC=${JSON.stringify(PRECACHE)};
        self.addEventListener('install',e=>e.waitUntil((async()=>{
          const c=await caches.open(C);
          await c.addAll(PREC);
          self.skipWaiting();
        })()));
        self.addEventListener('activate',e=>e.waitUntil((async()=>{
          const ks=await caches.keys();
          await Promise.all(ks.map(k=>{if(k!==C)return caches.delete(k)}));
          self.clients.claim();
        })()));
        self.addEventListener('fetch',e=>{
          const u=e.request.url;
          if (PREC.some(p=>u.startsWith(p.split('/').slice(0,5).join('/'))||u===p)){
            e.respondWith((async()=>{
              const c=await caches.open(C);
              const m=await c.match(e.request);
              if(m) return m;
              try{
                const f=await fetch(e.request,{cache:'no-store'});
                if(f&&f.ok) c.put(e.request,f.clone());
                return f;
              }catch{
                return m||Response.error();
              }
            })());
          }
        });
      `;
      const blob=new Blob([sw],{type:'text/javascript'});
      const url=URL.createObjectURL(blob);
      navigator.serviceWorker.register(url).catch(()=>{});
    }
  </script>

  <!-- Runtime esterni -->
  <script>
    const PYODIDE_URL="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js";
    const ZXING_URL="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.2/umd/index.min.js";
    const JSQR_URL="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js";
    const QRG_URL="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.js";
    const JSPDF_URL="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js";
    const PDFJS_URL="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js";
    const PDFJS_WORKER_URL="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";

    let pyodide,
        zxingReader=null,
        barcodeDetector=null,
        currentQRCanvas=null,
        decodedObj=null;

    let jsPDFmod=null,
        pdfjsLib=null;

    // camera state
    let camStream = null;
    let scanning = false;
    let trackTorchCapable = null;
    let torchOn = false;

    // app state
    const KEY_STORE='qrj1_simple_list_v2';
    const KEY_OPERATOR='qrj1_operator_name';
    let state = loadLocal() || { v:1, t:today(), b:"", e:"", l:[] };
    let selectedIndex = null;
    let operatorName = loadOperator() || "";

    (async()=>{
      setStatus("Carico runtime…");
      await loadScript(PYODIDE_URL);
      await Promise.all([
        loadScript(ZXING_URL),
        loadScript(JSQR_URL),
        loadScript(QRG_URL),
        loadScript(JSPDF_URL),
        loadScript(PDFJS_URL),
        loadScript(PDFJS_WORKER_URL)
      ]);

      pyodide = await loadPyodide({ indexURL:"https://cdn.jsdelivr.net/pyodide/v0.25.1/full/" });
      await initPython();
      await initDecoders();

      jsPDFmod = window.jspdf;
      pdfjsLib = window['pdfjs-dist/build/pdf'];
      if (pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = PDFJS_WORKER_URL;
      }

      setStatus("Pronto (offline dopo primo avvio).");

      // init UI
      applyMeta();
      renderTables();
      updateSelectedInfo();
      if (!operatorName){
        showLoginOverlay(true);
      } else {
        updateOperatorLabel();
      }
    })();

    function loadScript(src){
      return new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src=src;
        s.onload=res;
        s.onerror=rej;
        document.head.appendChild(s);
      });
    }

    function setStatus(t){
      document.getElementById('status').textContent=t;
    }

    async function initPython(){
      await pyodide.runPythonAsync(`
import json, zlib
_CH="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:"
_MAP={c:i for i,c in enumerate(_CH)}
def b45encode(data: bytes) -> str:
    out=[]; i=0; n=len(data)
    while i<n:
        if i+1<n:
            x=(data[i]<<8)|data[i+1]
            out.extend((_CH[x//(45*45)], _CH[(x//45)%45], _CH[x%45])); i+=2
        else:
            x=data[i]; out.extend((_CH[x//45], _CH[x%45])); i+=1
    return "".join(out)
def b45decode(s: str) -> bytes:
    buf=bytearray(); i=0; n=len(s)
    while i<n:
        if i+2<n:
            x=_MAP[s[i]]*45*45 + _MAP[s[i+1]]*45 + _MAP[s[i+2]]
            buf+=bytes([(x>>8)&0xFF, x&0xFF]); i+=3
        else:
            x=_MAP[s[i]]*45 + _MAP[s[i+1]]
            buf.append(x&0xFF); i+=2
    return bytes(buf)
SCHEME="QRJ1:"
def pack_json_str(s: str) -> str:
    comp=zlib.compress(s.encode("utf-8"),9)
    return SCHEME + b45encode(comp)
def unpack_to_pretty(s: str) -> str:
    if not s.startswith(SCHEME):
        raise ValueError("prefisso QRJ1: mancante")
    payload=s[len(SCHEME):]
    data=zlib.decompress(b45decode(payload)).decode("utf-8")
    obj=json.loads(data)
    return json.dumps(obj, ensure_ascii=False, indent=2)
      `);
    }

    async function initDecoders(){
      if('BarcodeDetector' in window){
        try{
          const fmts = await BarcodeDetector.getSupportedFormats?.()||[];
          if(fmts.includes('qr_code')||fmts.length){
            barcodeDetector=new BarcodeDetector({formats:['qr_code']});
          }
        }catch{}
      }
      zxingReader=new ZXing.BrowserMultiFormatReader();
    }
  </script>

  <!-- LOGICA APP -->
  <script>
    function today(){
      const d=new Date();
      return d.toISOString().slice(0,10);
    }

    function nowDateTime(){
      const d=new Date();
      const yyyy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,'0');
      const dd=String(d.getDate()).padStart(2,'0');
      const hh=String(d.getHours()).padStart(2,'0');
      const mi=String(d.getMinutes()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    /* === Operator handling === */
    function loadOperator(){
      try{
        return localStorage.getItem(KEY_OPERATOR)||"";
      }catch{
        return "";
      }
    }
    function saveOperator(name){
      try{
        localStorage.setItem(KEY_OPERATOR,name);
      }catch{}
    }
    function showLoginOverlay(show){
      const ov=document.getElementById('loginOverlay');
      if(show) ov.classList.remove('hidden'); else ov.classList.add('hidden');
    }
    function updateOperatorLabel(){
      document.getElementById('opInfo').textContent = "Operatore: "+(operatorName||"–");
    }

    document.getElementById('opNameConfirm').onclick=()=>{
      const v=document.getElementById('opNameInput').value.trim();
      if(!v){
        alert("Inserisci un nome operatore.");
        return;
      }
      operatorName = v;
      saveOperator(operatorName);
      updateOperatorLabel();
      showLoginOverlay(false);
    };

    /* === Navigazione Tabs === */
    document.querySelectorAll('nav button[data-tab]').forEach(b=>{
      b.onclick=()=>goTab(b.dataset.tab,true);
    });
    document.querySelectorAll('[data-go]').forEach(el=>{
      el.onclick=()=>goTab(el.getAttribute('data-go'),true);
    });

    function goTab(id,fromUser=false){
      document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active'));
      const nb=[...document.querySelectorAll('nav button[data-tab]')].find(b=>b.dataset.tab===id);
      if(nb) nb.classList.add('active');
      document.querySelectorAll('.tab').forEach(t=>t.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if(fromUser) window.scrollTo({top:0,behavior:'smooth'});
    }

    /* === Stato lista / sincronizzazione meta === */
    function syncMeta(){
      state.b=document.getElementById('boxId').value.trim();
      state.e=document.getElementById('eventName').value.trim();
      state.t=state.t||today();
    }
    function applyMeta(){
      document.getElementById('boxId').value=state.b||"";
      document.getElementById('eventName').value=state.e||"";
    }

    function saveLocal(obj){
      localStorage.setItem(KEY_STORE, JSON.stringify(obj));
    }
    function loadLocal(){
      try{
        const s=localStorage.getItem(KEY_STORE);
        return s?JSON.parse(s):null;
      }catch{
        return null;
      }
    }

    /* === Lista articoli base === */
    document.getElementById('addItem').onclick=()=>{
      const d=document.getElementById('desc').value.trim();
      const q=parseInt(document.getElementById('qty').value||"0",10);
      if(!d || q<=0){
        alert("Inserisci descrizione e quantità > 0");
        return;
      }
      state.l.push({d,q,r:0});
      document.getElementById('desc').value="";
      document.getElementById('qty').value="1";
      renderTables();
    };

    document.getElementById('saveLocal').onclick=()=>{
      syncMeta();
      saveLocal(state);
      alert("Salvato in locale.");
    };

    document.getElementById('loadLocal').onclick=()=>{
      const s=loadLocal();
      if(s){
        state=s;
        applyMeta();
        selectedIndex=null;
        renderTables();
        updateSelectedInfo();
      } else {
        alert("Nessun dato locale.");
      }
    };

    document.getElementById('clearList').onclick=()=>{
      if(confirm("Svuotare la lista?")){
        state.l=[];
        renderTables();
      }
    };

    document.getElementById('exportJson').onclick=()=>{
      const j = canonicalJSON(state,true);
      downloadBlob(new Blob([j],{type:'application/json'}),'lista.json');
    };

    function renderTables(){
      const tb=document.querySelector('#itemsTbl tbody');
      tb.innerHTML="";
      state.l.forEach((it,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${idx+1}</td>
          <td>${escapeHtml(it.d)}</td>
          <td>${it.q}</td>
          <td class="noprint">
            <button class="btn sm ghost" data-del="${idx}">Elimina</button>
          </td>`;
        tb.appendChild(tr);
      });

      tb.querySelectorAll('button[data-del]').forEach(b=>{
        b.onclick=()=>{
          const i=parseInt(b.dataset.del,10);
          state.l.splice(i,1);
          renderTables();
        };
      });

      renderRientroTable();
    }

    function escapeHtml(s){
      return s.replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    /* === QR & Stampa / PDF scheda === */
    let lastPayloadText = "";

    document.getElementById('btnGenQR').onclick=async ()=>{
      syncMeta();
      if(!state.b || !state.e){
        alert("Compila ID baule ed Evento.");
        return;
      }
      const canon = canonicalJSON(state,true);
      document.getElementById('jsonCanon').value = canon;
      document.getElementById('sha256').textContent = await sha256hex(canon);

      try{
        lastPayloadText = await pyodide.runPythonAsync(
          `pack_json_str(${JSON.stringify(canon)})`
        );
      }catch(e){
        alert("Errore pack Python: "+e);
        return;
      }

      const sizeMm = parseFloat(document.getElementById('sizeMm').value||"40");
      const border = parseInt(document.getElementById('borderMods').value||"4",10);
      currentQRCanvas = makeQrCanvas(lastPayloadText, border);

      const box=document.getElementById('qrBox');
      box.innerHTML="";
      box.appendChild(currentQRCanvas);
      currentQRCanvas.style.width = Math.round(sizeMm*3.78) + "px";

      document.getElementById('encInfo').textContent =
        `Quiet zone ${border} moduli, ECC=H.`;

      document.getElementById('btnDownloadPNG').disabled=false;
      document.getElementById('btnPrint').disabled=false;
      document.getElementById('btnPDFMain').disabled=false;

      prepPrintSheet(border);
    };

    document.getElementById('btnDownloadPNG').onclick=()=>{
      if(!currentQRCanvas) return;
      const sizeMm = parseFloat(document.getElementById('sizeMm').value||"40");
      const DPI=300;
      const px=Math.round((sizeMm/25.4)*DPI);
      const out=document.createElement('canvas');
      out.width=px;
      out.height=px;
      const g=out.getContext('2d');
      g.imageSmoothingEnabled=false;
      g.fillStyle='#fff';
      g.fillRect(0,0,px,px);
      g.drawImage(currentQRCanvas,0,0,px,px);
      downloadBlob(dataURLtoBlob(out.toDataURL('image/png')), 'qr_baule.png');
    };

    // ora "Stampa scheda" deve stampare l'etichetta con data/ora
    document.getElementById('btnPrint').onclick=()=>{
      // aggiorna data/ora prima di print()
      prepPrintSheet(parseInt(document.getElementById('borderMods').value||"4",10));
      window.print();
    };

    document.getElementById('btnPDFMain').onclick=()=>{
      exportPDFScheda(false);
    };

    document.getElementById('rPDF').onclick=()=>{
      exportPDFScheda(true);
    };

    function makeQrCanvas(text, borderMods){
      const typeNumber=0;
      const qr = qrcode(typeNumber, 'H');
      qr.addData(text);
      qr.make();

      const m=qr.getModuleCount();
      const mp=m+borderMods*2;
      const px=Math.max(256, mp*8);
      const c=document.createElement('canvas');
      c.width=px;
      c.height=px;
      const g=c.getContext('2d');
      g.imageSmoothingEnabled=false;
      g.fillStyle='#fff';
      g.fillRect(0,0,px,px);
      const s=px/mp;
      g.fillStyle='#000';
      for(let r=0;r<m;r++){
        for(let col=0;col<m;col++){
          if(qr.isDark(r,col)){
            g.fillRect(
              Math.round((col+borderMods)*s),
              Math.round((r+borderMods)*s),
              Math.ceil(s),
              Math.ceil(s)
            );
          }
        }
      }
      return c;
    }

    // Prepara il foglio di stampa A4 landscape (etichetta)
    function prepPrintSheet(border){
      document.getElementById('pBox').textContent      = state.b || "";
      document.getElementById('pEvent').textContent    = state.e || "";
      document.getElementById('pOperatore').textContent= operatorName||"";
      document.getElementById('pWhen').textContent     = nowDateTime();

      const list = state.l.map(x=>`- ${x.d} × ${x.q}`).join('\n');
      document.getElementById('pList').textContent = list;

      // rigenera QR per stampa
      const c=makeQrCanvas(lastPayloadText || "", border||4);
      const target=document.getElementById('printQR');
      target.width=c.width;
      target.height=c.height;
      target.getContext('2d').drawImage(c,0,0);
    }

    // PDF export: lista e/o rientro
    function exportPDFScheda(withRientro){
      if(!jsPDFmod){
        alert("jsPDF non caricato");
        return;
      }
      const { jsPDF } = jsPDFmod;

      const doc = new jsPDF({
        orientation:"landscape",
        unit:"mm",
        format:"a4"
      });

      function slugify(s){
        return (s || "")
          .trim()
          .replace(/\s+/g,"_")
          .replace(/[^A-Za-z0-9_\-]+/g,"");
      }

      // calcolo se incompleto
      let incompleto = false;
      if (withRientro) {
        for (const it of state.l) {
          const r = it.r || 0;
          if (r < it.q) { incompleto = true; break; }
        }
      }

      const marginL = 15;
      const marginT = 20;
      const pageW   = 297;

      // Testata
      doc.setFont("helvetica","bold");
      doc.setFontSize(20);
      doc.text(`Evento: ${state.e || ""}`, marginL, marginT);

      doc.setFontSize(24);
      doc.text(`Baule: ${state.b || ""}`, marginL, marginT + 10);

      doc.setFontSize(12);
      doc.setFont("helvetica","normal");
      doc.text(`Operatore: ${operatorName||""}`, marginL, marginT + 20);
      doc.text(`Data/ora: ${nowDateTime()}`, marginL, marginT + 26);

      let curY = marginT + 36;

      // Stato rientro
      if (withRientro && incompleto) {
        doc.setFont("helvetica","bold");
        doc.setFontSize(28);
        doc.setTextColor(255,0,0);
        doc.text("INCOMPLETO", marginL, curY);
        doc.setTextColor(0,0,0);
        curY += 15;
      } else if (withRientro && !incompleto) {
        doc.setFont("helvetica","bold");
        doc.setFontSize(16);
        doc.setTextColor(16,185,129);
        doc.text("TUTTO RIENTRATO", marginL, curY);
        doc.setTextColor(0,0,0);
        curY += 10;
      }

      // Lista materiali
      doc.setFont("helvetica","bold");
      doc.setFontSize(14);

      if (withRientro) {
        doc.text("Materiali (Previsti / Rientrati / Mancano):", marginL, curY);
      } else {
        doc.text("Materiali (Quantità previste):", marginL, curY);
      }
      curY += 8;

      doc.setFont("helvetica","normal");
      doc.setFontSize(12);

      const maxTextW = 180;
      state.l.forEach((it)=>{
        const prev = it.q;
        const rin  = it.r || 0;
        const manc = Math.max(0, prev - rin);

        let line;
        if (withRientro) {
          line = `- ${it.d} | ${prev} / ${rin} / ${manc}`;
        } else {
          line = `- ${it.d} × ${prev}`;
        }

        const wrapped = doc.splitTextToSize(line, maxTextW);
        wrapped.forEach(st=>{
          if (curY > 190) {
            doc.addPage("a4","landscape");
            curY = marginT;
          }
          doc.text(st, marginL, curY);
          curY += 6;
        });
      });

      // QR code in alto a destra
      const canon = canonicalJSON(state,true);
      pyodide.runPythonAsync(
        `pack_json_str(${JSON.stringify(canon)})`
      ).then(qp=>{
        const qrCanvas = makeQrCanvas(qp, 4);
        const qrDataURL = qrCanvas.toDataURL("image/png");

        const qrSizeMm = 60;
        const qrX = pageW - qrSizeMm - 15;
        const qrY = marginT;

        doc.addImage(qrDataURL, "PNG", qrX, qrY, qrSizeMm, qrSizeMm);

        const baseName =
          slugify(state.e || "evento") + "_" +
          slugify(state.b || "baule") +
          (withRientro ? "_RIENTRO" : "");

        doc.save(baseName + ".pdf");
      });
    }

    /* === Decode / import da QR o PDF === */
    const decStatus   = document.getElementById('decStatus');
    const rawOut      = document.getElementById('rawOut');
    const jsonDecoded = document.getElementById('jsonDecoded');
    const btnSetCurrent = document.getElementById('btnSetCurrent');
    const btnCompare    = document.getElementById('btnCompare');
    const cmpResult     = document.getElementById('cmpResult');

    document.getElementById('fileInput').addEventListener('change', async ev=>{
      const f=ev.target.files?.[0];
      if(!f) return;
      decStatus.textContent="Decodifica…";

      if (f.type === "application/pdf") {
        try{
          const text = await decodeFromPDF(f);
          await handleDecodedText(text);
        }catch(e){
          decStatus.innerHTML=`<span class="err">${e}</span>`;
        }
      } else {
        const url=URL.createObjectURL(f);
        try{
          const img=new Image();
          await new Promise(r=>{ img.onload=r; img.src=url; });
          const text=await robustDecodeFromImage(img);
          URL.revokeObjectURL(url);
          await handleDecodedText(text);
        }catch(e){
          URL.revokeObjectURL(url);
          decStatus.innerHTML=`<span class="err">${e}</span>`;
        }
      }
    });

    // direttamente da scatto singolo (no overlay live)
    document.getElementById('cameraShot').addEventListener('change', async ev=>{
      const f=ev.target.files?.[0];
      if(!f) return;
      decStatus.textContent="Decodifica foto…";

      const url=URL.createObjectURL(f);
      try{
        const img=new Image();
        await new Promise(r=>{ img.onload=r; img.src=url; });
        const text=await robustDecodeFromImage(img);
        URL.revokeObjectURL(url);
        await handleDecodedText(text);
      }catch(e){
        URL.revokeObjectURL(url);
        decStatus.innerHTML=`<span class="err">${e}</span>`;
      }
    });

    btnSetCurrent.onclick=()=>{
      try{
        const obj=JSON.parse(jsonDecoded.value);

        // normalizza item per avere anche r
        obj.l = (obj.l || []).map(item=>({
          d:item.d,
          q:item.q,
          r:item.r || 0
        }));

        state=obj;
        applyMeta();
        selectedIndex = null;
        renderTables();
        updateProgress();
        saveLocal(state);
        updateSelectedInfo();

        alert("Lista impostata come corrente.");
      }catch(e){
        alert("JSON non valido.");
      }
    };

    btnCompare.onclick=async()=>{
      try{
        const a = canonicalJSON(state,true);
        const b = canonicalJSON(JSON.parse(jsonDecoded.value),true);
        const equal = (await sha256hex(a)) === (await sha256hex(b));
        cmpResult.innerHTML = equal
          ? '<span class="ok">La lista coincide.</span>'
          : '<span class="warn">Le liste sono diverse.</span>';
      }catch(e){
        cmpResult.innerHTML=`<span class="err">${e}</span>`;
      }
    };

    async function handleDecodedText(text){
      if(!text){
        decStatus.innerHTML=`<span class="warn">Nessun QR leggibile.</span>`;
        rawOut.textContent="";
        jsonDecoded.value="";
        btnSetCurrent.disabled=true;
        btnCompare.disabled=true;
        return;
      }
      rawOut.textContent=text;
      try{
        const pretty=await pyodide.runPythonAsync(
          `unpack_to_pretty(${JSON.stringify(text)})`
        );
        jsonDecoded.value=pretty;
        decodedObj=JSON.parse(pretty);
        decodedObj.l = decodedObj.l.map(it=>({d:it.d,q:it.q,r:it.r||0}));

        decStatus.innerHTML=`<span class="ok">QRJ1 decodificato.</span>`;
        btnSetCurrent.disabled=false;
        btnCompare.disabled=false;

        // aggiorniamo anche operatorName? NO: QR non definisce operatore.
      }catch{
        jsonDecoded.value="";
        decodedObj=null;
        decStatus.innerHTML=`<span class="warn">QR letto ma non QRJ1.</span>`;
        btnSetCurrent.disabled=true;
        btnCompare.disabled=true;
      }
    }

    /* === Rientro + progress bar === */
    function ensureRientroStore(){
      if(!state.l){ state.l=[]; }
      state.l = state.l.map(it=>({
        d:it.d,
        q:it.q,
        r: (typeof it.r==="number"?it.r:0)
      }));
    }

    function updateSelectedInfo(){
      const nameEl = document.getElementById('rSelName');
      const metaEl = document.getElementById('rSelMeta');

      if (selectedIndex == null || !state.l[selectedIndex]) {
        nameEl.textContent = "Nessun articolo selezionato";
        metaEl.textContent = "Previsti: — • Rientrati: — • Mancano: —";
        return;
      }

      const it   = state.l[selectedIndex];
      const prev = it.q;
      const rin  = it.r || 0;
      const manc = Math.max(0, prev - rin);

      nameEl.textContent = it.d || "(senza descrizione)";
      metaEl.textContent = `Previsti: ${prev} • Rientrati: ${rin} • Mancano: ${manc}`;
    }

    function renderRientroTable(){
      ensureRientroStore();

      const tb=document.querySelector('#rTbl tbody');
      tb.innerHTML="";
      let totPrev=0, totR=0;

      state.l.forEach((it,idx)=>{
        totPrev+=it.q;
        const r=it.r||0;
        totR+=Math.min(it.q, r);
        const manca = Math.max(0, it.q - r);

        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${idx+1}</td>
          <td>${escapeHtml(it.d)}</td>
          <td>${it.q}</td>
          <td><input class="rQtyInput" type="number" min="0" max="${it.q}" value="${r}" data-r="${idx}"></td>
          <td>${manca}</td>
        `;

        if (idx === selectedIndex) {
          tr.classList.add('selected');
        }

        tr.addEventListener('click', () => {
          selectedIndex = idx;
          updateSelectedInfo();
          renderRientroTable(); // highlight aggiornata
        });

        tb.appendChild(tr);
      });

      // listener sugli <input> quantità rientrati
      tb.querySelectorAll('input[data-r]').forEach(inp=>{
        const idx = +inp.dataset.r;
        inp.addEventListener('input', () => {
          let v = parseInt(inp.value || "0", 10);
          if (Number.isNaN(v)) v = 0;
          v = Math.max(0, Math.min(state.l[idx].q, v));
          state.l[idx].r = v;

          if (idx === selectedIndex) {
            updateSelectedInfo();
          }

          updateProgress();
          saveLocal(state);
        });

        inp.addEventListener('change', () => {
          let v = parseInt(inp.value || "0", 10);
          if (Number.isNaN(v)) v = 0;
          v = Math.max(0, Math.min(state.l[idx].q, v));
          state.l[idx].r = v;

          if (idx === selectedIndex) {
            updateSelectedInfo();
          }

          updateProgress();
          saveLocal(state);
          renderRientroTable();
        });
      });

      document.getElementById('rInfo').textContent=`Totale previsti: ${totPrev}`;
      updateProgress(totR, totPrev);

      updateSelectedInfo();
    }

    function updateProgress(cur=null, tot=null){
      ensureRientroStore();
      let totPrev=0, totR=0;
      if (cur===null || tot===null){
        state.l.forEach(it=>{
          totPrev+=it.q;
          totR+=Math.min(it.q, it.r||0);
        });
      } else {
        totPrev=tot;
        totR=cur;
      }
      const pct = totPrev>0 ? Math.round(100*totR/totPrev) : 0;
      const bar=document.getElementById('rBar');
      bar.style.width = pct+'%';
      document.getElementById('rPct').textContent =
        `${pct}% • ${totR}/${totPrev}`;
    }

    document.getElementById('rReset').onclick=()=>{
      ensureRientroStore();
      state.l.forEach(it=>{it.r=0;});
      updateProgress();
      renderRientroTable();
      saveLocal(state);
    };

    document.getElementById('rAll').onclick=()=>{
      ensureRientroStore();
      state.l.forEach(it=>{it.r=it.q;});
      updateProgress();
      renderRientroTable();
      saveLocal(state);
    };

    document.getElementById('rExport').onclick=()=>{
      ensureRientroStore();
      const rows=[
        ["ID baule", state.b],
        ["Evento", state.e],
        ["Operatore", operatorName || ""],
        ["Data/ora export", nowDateTime()],
        [],
        ["Descrizione","Prev","Rientrati","Manca"]
      ];
      state.l.forEach((it)=>{
        const manque=Math.max(0, it.q-(it.r||0));
        rows.push([it.d, it.q, it.r||0, manque]);
      });
      const csv=rows.map(r=>r.join(";")).join("\n");
      downloadBlob(new Blob([csv],{type:'text/csv'}), 'rientro.csv');
    };

    // Pulsanti grandi toolbar rientro
    document.getElementById('btnIncOne').onclick  = ()=>adjustSelected('inc');
    document.getElementById('btnDecOne').onclick  = ()=>adjustSelected('dec');
    document.getElementById('btnAllOne').onclick  = ()=>adjustSelected('all');
    document.getElementById('btnZeroOne').onclick = ()=>adjustSelected('zero');

    function adjustSelected(mode){
      if (selectedIndex == null || !state.l[selectedIndex]) return;
      const it = state.l[selectedIndex];

      if (mode === 'inc'){
        it.r = Math.min(it.q, (it.r||0)+1);
      } else if (mode === 'dec'){
        it.r = Math.max(0, (it.r||0)-1);
      } else if (mode === 'all'){
        it.r = it.q;
      } else if (mode === 'zero'){
        it.r = 0;
      }

      updateSelectedInfo();
      updateProgress();
      saveLocal(state);
      renderRientroTable();
    }

    /* === Utilità comuni === */
    function canonicalJSON(obj, includeRientro){
      const o = {
        v:1,
        t: obj.t || today(),
        b: obj.b||"",
        e: obj.e||"",
        l: obj.l.map(x=>({
          d:x.d,
          q:x.q,
          r: (includeRientro ? (x.r||0) : 0)
        })),
        op: operatorName || ""
      };
      return JSON.stringify(o, (k,v)=>{
        if (Array.isArray(v)) return v;
        if (v && typeof v==='object'){
          const out={};
          Object.keys(v).sort().forEach(k=>out[k]=v[k]);
          return out;
        }
        return v;
      });
    }

    async function sha256hex(s){
      const buf=new TextEncoder().encode(s);
      const h=await crypto.subtle.digest('SHA-256', buf);
      return [...new Uint8Array(h)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function dataURLtoBlob(dataURL){
      const b=atob(dataURL.split(',')[1]);
      const len=b.length;
      const u8=new Uint8Array(len);
      for(let i=0;i<len;i++) u8[i]=b.charCodeAt(i);
      return new Blob([u8],{type:'image/png'});
    }

    function downloadBlob(blob, name){
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=name;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 4000);
    }

    /* === QR decoding helpers === */
    function drawToCanvas(img){
      const c=document.createElement('canvas');
      c.width=img.naturalWidth||img.videoWidth||img.width;
      c.height=img.naturalHeight||img.videoHeight||img.height;
      c.getContext('2d',{willReadFrequently:true}).drawImage(img,0,0,c.width,c.height);
      return c;
    }

    function toGray(c){
      const ctx=c.getContext('2d',{willReadFrequently:true});
      const d=ctx.getImageData(0,0,c.width,c.height);
      const a=d.data;
      for(let i=0;i<a.length;i+=4){
        const y=(a[i]*0.2126+a[i+1]*0.7152+a[i+2]*0.0722)|0;
        a[i]=a[i+1]=a[i+2]=y;
      }
      const out=document.createElement('canvas');
      out.width=c.width;
      out.height=c.height;
      out.getContext('2d').putImageData(d,0,0);
      return out;
    }

    function otsu(c){
      const ctx=c.getContext('2d',{willReadFrequently:true});
      const d=ctx.getImageData(0,0,c.width,c.height),
            a=d.data,
            hist=new Array(256).fill(0);

      for(let i=0;i<a.length;i+=4) hist[a[i]]++;

      const total=c.width*c.height;
      let sum=0;
      for(let t=0;t<256;t++) sum+=t*hist[t];
      let sumB=0,wB=0,varMax=0,th=128;
      for(let t=0;t<256;t++){
        wB+=hist[t];
        if(!wB) continue;
        const wF=total-wB;
        if(!wF) break;
        sumB+=t*hist[t];
        const mB=sumB/wB,mF=(sum-sumB)/wF;
        const between=wB*wF*(mB-mF)*(mB-mF);
        if(between>varMax){
          varMax=between;
          th=t;
        }
      }
      for(let i=0;i<a.length;i+=4){
        const v=a[i]<th?0:255;
        a[i]=a[i+1]=a[i+2]=v;
      }
      const out=document.createElement('canvas');
      out.width=c.width;
      out.height=c.height;
      out.getContext('2d').putImageData(d,0,0);
      return out;
    }

    function rotate(c,deg){
      const o=document.createElement('canvas'),
            g=o.getContext('2d');
      if(deg%180===0){
        o.width=c.width;
        o.height=c.height;
      }else{
        o.width=c.height;
        o.height=c.width;
      }
      g.translate(o.width/2,o.height/2);
      g.rotate(deg*Math.PI/180);
      g.imageSmoothingEnabled=false;
      g.drawImage(c,-c.width/2,-c.height/2);
      return o;
    }

    function scale(c,s){
      const o=document.createElement('canvas');
      o.width=Math.max(1,Math.round(c.width*s));
      o.height=Math.max(1,Math.round(c.height*s));
      const g=o.getContext('2d');
      g.imageSmoothingEnabled=false;
      g.drawImage(c,0,0,o.width,o.height);
      return o;
    }

    function getImageData(c){
      return c.getContext('2d',{willReadFrequently:true}).getImageData(0,0,c.width,c.height);
    }

    async function tryDecodeCanvas(cnv){
      if(barcodeDetector){
        try{
          const codes=await barcodeDetector.detect(cnv);
          if(codes?.length && codes[0].rawValue) return codes[0].rawValue;
        }catch{}
      }
      if(zxingReader && typeof zxingReader.decodeFromCanvas==='function'){
        try{
          const r=await zxingReader.decodeFromCanvas(cnv);
          if(r?.text) return r.text;
        }catch{}
      }
      if(typeof jsQR==='function'){
        try{
          const id=getImageData(cnv);
          const r=jsQR(id.data,id.width,id.height,{inversionAttempts:"attemptBoth"});
          if(r?.data) return r.data;
        }catch{}
      }
      return null;
    }

    async function robustDecodeFromCanvas(baseCanvas){
      const vars=[baseCanvas, toGray(baseCanvas), otsu(baseCanvas)];
      const ang=[0,90,180,270],
            sc=[1.0,1.4,1.8,2.2];
      for(const a of ang){
        const rot=vars.map(v=>a?rotate(v,a):v);
        for(const s of sc){
          for(const v of rot){
            const c=(Math.abs(s-1)<1e-3)?v:scale(v,s);
            const t=await tryDecodeCanvas(c);
            if(t) return t;
          }
        }
      }
      return null;
    }

    async function robustDecodeFromImage(imgEl){
      const base=drawToCanvas(imgEl);
      return robustDecodeFromCanvas(base);
    }

    async function decodeFromPDF(file){
      if(!pdfjsLib) throw new Error("pdf.js non caricato");
      const arrBuf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data:arrBuf}).promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({scale:2});
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      await page.render({canvasContext:ctx, viewport}).promise;
      const text = await robustDecodeFromCanvas(canvas);
      return text;
    }

    /* === Camera overlay live === */
    const camOverlay   = document.getElementById('camOverlay');
    const camVideo     = document.getElementById('camVideo');
    const camSnap      = document.getElementById('camSnap');
    const camStatus    = document.getElementById('camStatus');
    const camCloseBtn  = document.getElementById('camCloseBtn');
    const camFlashBtn  = document.getElementById('camFlashBtn');
    const btnCamFull   = document.getElementById('btnCamFull');

    btnCamFull.onclick = async ()=>{
      await startCameraOverlay();
    };

    camCloseBtn.onclick = ()=>{
      stopCameraOverlay("Chiuso");
    };

    camFlashBtn.onclick = async ()=>{
      if(!trackTorchCapable) return;
      torchOn = !torchOn;
      await setTorch(trackTorchCapable, torchOn);
      camFlashBtn.classList.toggle("active", torchOn);
      camFlashBtn.textContent = torchOn ? "Flash ON" : "Flash OFF";
    };

    async function setTorch(track, on){
      if(!track) return;
      try{
        await track.applyConstraints({
          advanced:[{torch:on}]
        });
      }catch(e){
        // se fallisce lasciamo stare
      }
    }

    async function startCameraOverlay(){
      // HTTPS check
      const isSecure = (
        location.protocol === 'https:' ||
        location.hostname === 'localhost' ||
        location.hostname === '127.0.0.1'
      );
      if (!isSecure){
        alert("Per la webcam live serve HTTPS o localhost.");
        return;
      }

      camOverlay.style.display="flex";
      camStatus.textContent="Avvio camera…";

      try{
        camStream = await navigator.mediaDevices.getUserMedia({
          video:{facingMode:'environment'}
        });
      }catch(e){
        camStatus.textContent="Webcam non disponibile";
        return;
      }

      camVideo.srcObject = camStream;
      scanning = true;
      // torch support?
      torchOn=false;
      trackTorchCapable = null;
      camFlashBtn.disabled = true;
      camFlashBtn.classList.remove("active");
      camFlashBtn.textContent = "Flash";

      const tracks = camStream.getVideoTracks();
      if (tracks && tracks[0]){
        const track = tracks[0];
        const caps = track.getCapabilities?.();
        if(caps && 'torch' in caps){
          trackTorchCapable = track;
          camFlashBtn.disabled = false;
        }
      }

      camStatus.textContent="Inquadra il QR…";

      // start loop
      tickScanOverlay();
    }

    function stopCameraOverlay(msg){
      if(camStream){
        camStream.getTracks().forEach(t=>t.stop());
        camStream=null;
      }
      scanning=false;
      camOverlay.style.display="none";
      camStatus.textContent = msg || "";
    }

    async function tickScanOverlay(){
      if(!scanning || !camStream) return;

      if (camVideo.readyState === camVideo.HAVE_ENOUGH_DATA){
        camSnap.width  = camVideo.videoWidth;
        camSnap.height = camVideo.videoHeight;
        const gx = camSnap.getContext('2d');
        gx.drawImage(camVideo,0,0,camSnap.width,camSnap.height);

        robustDecodeFromCanvas(camSnap).then(async text=>{
          if (text && scanning){
            scanning=false;
            stopCameraOverlay("QR rilevato.");
            await handleDecodedText(text);
          } else {
            camStatus.textContent = "Inquadra il QR…";
          }
        });
      }

      if (scanning){
        setTimeout(()=>{ requestAnimationFrame(tickScanOverlay); }, 200);
      }
    }

    /* === HTTPS fallback warning was moved into overlay logic === */

    /* === anti double-tap zoom iOS === */
    (function(){
      let lastTouch = 0;
      document.addEventListener('touchend', function(e){
        const now = Date.now();
        const dt = now - lastTouch;
        if (dt > 0 && dt < 300) {
          e.preventDefault();
        }
        lastTouch = now;
      }, { passive:false });
    })();
  </script>
</body>
</html>
